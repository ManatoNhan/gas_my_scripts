## システム概要

### 機能概要

画像買い取り企業案件の進捗報告を自動化するシステムです。スプレッドシートでクライアント情報を管理し、指定したタイミングで進捗報告メールを自動送信します。

### 主要機能

- **クライアント情報管理**: 企業情報、担当者、メールアドレス等の一元管理
- **URL自動生成**: ダッシュボードURL（Metabase等）の自動生成
- **自動メール送信**: 進捗報告メールの一括送信
- **実行ログ管理**: 送信履歴とエラー情報の記録

---

## 利用における注意点

- 本システムを使ってクライアントへ共有を行う場合、[ONE利用規約](https://drive.google.com/drive/folders/17KQUb6Bn9gdBAdVDWnL9896iS4fkXnCO)への同意が必要である
- 利用規約への同意一覧は契約[管理台帳](https://docs.google.com/spreadsheets/d/1Ear7u2J9RSdGT8x3ZbJ7J3q6IAUgxe3z4zkljdFw1c4/edit?gid=1372943846#gid=1372943846)を参照のこと

---

## 現在使用中のスプレッドシート

https://docs.google.com/spreadsheets/d/1TKWB8ZNZOjnxen5PzLydZlEAsWekAcXvCe2EpXTwDTw/edit?gid=2112306312#gid=2112306312

---

## データ入力方法

### Client_List シート

| 列 | 項目名 | 説明 | 例 |
| --- | --- | --- | --- |
| A | クライアント名 | 企業名 | 株式会社サンプル |
| B | 担当者名 | 担当者の氏名 | 田中太郎、田中 など |
| C | 担当者メールアドレス（To） | 送信先メール
（複数可 ,カンマ区切り） | tanaka@sample.com |
| D | CCメールアドレス | CC送信先
（複数可 ,カンマ区切り） | manager@sample.com |
| E | 営業担当メールアドレス | 問い合わせ先メール | yamada@wed.company |
| F | 営業担当者名 | 営業担当者名 | 山田花子 |
| G | 商材名 | キャンペーン名 | 夏の写真買取キャンペーン |
| H | URLフォーマット指定 | URLフォーマット番号（0,1,2…） | 0 |
| I | ミッションタイプ | 0:通常, 1:グループ | 0 |
| J | Campaign_id | キャンペーンID | 12345 |
| K | パラメータを反映させたURL | **自動生成** | （入力不要） |
| L | 最終報告日 | 前回送信日 | 2025/06/01 |
| M | 報告インターバル（日数） | 報告間隔 | 7 |
| N | 次回報告予定日 | **自動計算** | （入力不要） |
| O | 処理フラグ | **チェックボックス** | （手動操作） |
| P | メール追加文言 | 追加メッセージ | 今週は好調です |

### URLフォーマット シート

| 列 | 項目名 | 説明 | 例 |
| --- | --- | --- | --- |
| A | フォーマット番号 | 0から始まる番号 | 0 |
| B | URL | ベースURL | https://metabase.wed.company/dashboard/123 |
| C | 備考 | 用途説明 | メインダッシュボード |

**重要**: URLには `?` や `&` が含まれていても自動でパラメータが追加されます。

---

## 日常操作

### 基本ワークフロー

### 1. 報告対象をチェック（参考）

```
メニュー: 🔍 報告対象をチェック（参考）
```

- 次回報告予定日と今日の日付を比較
- 報告が必要な行に **参考として** チェックを設定
- **実際の送信は手動でO列(チェックボックス)を調整**

### 2. 手動での送信対象調整

- O列（処理フラグ）を確認
- 実際に送信したい行に **手動でチェック** を入れる
- 送信不要な行はチェックを外す

### 3. メール送信実行

```
メニュー: 📧 メール送信実行
```

- **O列にチェックが入っている行のみ** が送信対象
- 送信前に対象一覧が表示される
- 確認後、一括送信実行

### メール送信の流れ

1. **対象確認画面**
    
    ```
    3件のメール送信を実行しますか？
    
    送信対象一覧:
    1. 株式会社サンプル - 田中太郎 (tanaka@sample.com)
    2. 株式会社テスト - 佐藤次郎 (sato@test.com)
    3. 株式会社デモ - 鈴木三郎 (suzuki@demo.com)
    ```
    
2. **自動送信処理**
    - 各クライアントに個別メール送信
    - 送信後、処理フラグを自動でOFFに設定
    - 最終報告日を更新
    - 結果をS列・T列に記録
3. **完了通知**
    
    ```
    メール送信完了
    
    成功: 3件
    エラー: 0件
    ```
    

### メールテンプレート

```
件名: 【ONE: [商材名(G列)]】進捗報告

[クライアント名(A列)]
[担当者名(B列)] 様

お世話になっております。
WED株式会社です。

※本メールは自動配信になります
※お問い合わせは担当の[営業担当者名(F列)]([営業担当メール(E列)])までご連絡ください

現在、実施中のキャンペーン「[商材名(G列)]」の進捗を下記URLからご確認ください。
【進捗報告】[自動生成URL(K列)]

[追加文言があれば挿入(P列)]

よろしくお願いいたします。
```

---

## エイリアス設定

### Gmail側での設定

### 個人Gmailの場合

1. **Gmail設定** → **アカウントとインポート**
2. **名前** セクション → **メールアドレスを追加**
3. エイリアスメールアドレスを入力
4. 確認コードで認証完了

### G Workspaceの場合

1. 管理者にエイリアス作成を依頼
2. 作成後、個人設定で送信者として追加

### GAS側での設定確認

### エイリアス設定確認

```
メニュー: 📤 エイリアス設定 → エイリアス設定確認
```

- 設定手順のガイドを表示
- 現在のGAS設定値を確認

### エイリアステスト送信

```
メニュー: 📤 エイリアス設定 → エイリアステスト送信
```

1. テスト送信先メールアドレスを入力
2. 確認画面で設定内容を確認
3. テストメール送信
4. 受信メールで送信者情報を確認

---

## トラブルシューティング

### よくあるエラーと対処法

### 1. エイリアス関連エラー

```
エラー: 指定されたエイリアス「sales@wed.company」が無効です
```

**対処法:**
- Gmail設定でエイリアスが正しく設定されているか確認
- エイリアス認証が完了しているか確認
- EMAIL_CONFIGの設定値を確認

### 2. メール送信失敗

```
エラー: Gmail送信エラー: Invalid email address
```

**対処法:**
- TO欄のメールアドレス形式を確認
- CC欄の区切り文字を確認（`,` `；` `、` に対応）
- 空のメールアドレスが含まれていないか確認

### 3. URL生成エラー

```
エラー: K列のURLが生成されない
```

**対処法:**
- H列に正しいフォーマット番号が入力されているか確認
- J列にCampaign_idが入力されているか確認
- URLフォーマットシートにデータが登録されているか確認

### 4. データ取得エラー

```
エラー: データが登録されていません
```

**対処法:**
- C列（メールアドレス）とJ列（Campaign_id）の両方が入力されているか確認
- 空白行や不完全なデータを削除

### Gmail API制限について

**日次制限**: 100通/日
**対処法**:
- 大量送信時は複数日に分散
- エラー時は翌日再実行

---

## 仕様詳細

### URL自動生成仕様

### パラメータ生成ルール

- **I列=0（通常）**: `receipt_campaign_id=[J列の値]`
- **I列=1（グループ）**: `receipt_campaign_group_id=[J列の値]`

### URL結合例

```
ベースURL: https://metabase.wed.company/dashboard/123
Campaign_id: 12345
ミッションタイプ: 0

結果: https://metabase.wed.company/dashboard/123?receipt_campaign_id=12345
```

### データ検証仕様

### 実データ行の判定

- **C列（メールアドレス）** AND **J列（Campaign_id）** の両方が入力されている行のみ
- 空白行や不完全なデータは処理対象外

### チェックボックス範囲

- 最大100行まで自動設定
- 実データ行のみに制限することでパフォーマンス向上

### ログ仕様

### ExecutionLogシート記録項目

1. 実行日時
2. 処理タイプ（報告対象チェック、メール送信、エラー等）
3. クライアント名
4. 担当者名
5. メールアドレス
6. 結果（成功/エラー）
7. メッセージ詳細
8. 送信ID（UUID）

### メールアドレス分割仕様

### 対応区切り文字

- `,` （半角カンマ）
- `；` （半角セミコロン）
- `、` （全角カンマ）
- `；` （全角セミコロン）

### 処理例

```
入力: "tanaka@sample.com,sato@test.com；suzuki@demo.com"
結果: ["tanaka@sample.com", "sato@test.com", "suzuki@demo.com"]
```

---

## 注意事項

### セキュリティ

- エイリアス設定には管理者権限が必要な場合があります
- 送信ログには個人情報が含まれるため、適切な管理を行ってください

### 運用

- 定期的にExecutionLogシートを確認し、エラーの有無をチェック
- 大量データ処理時はブラウザのタイムアウトに注意
- バックアップとして定期的にスプレッドシートをコピー保存

### 制限事項

- Gmail API: 1日100通まで
- スプレッドシート: 最大100行のデータ処理を想定
- ブラウザ: 長時間処理時のタイムアウトの可能性

---

## サポート情報

### 更新履歴

- v1.0: 初版リリース
- メール本文テンプレート調整
- URL生成パラメータ名変更（receipt_campaign_id/receipt_campaign_group_id）
- エイリアス機能強化

### 開発者向け情報

- 言語: Google Apps Script (JavaScript ES6)
- 依存関係: Gmail API, Spreadsheet API
- ライブラリ: 標準ライブラリのみ使用
