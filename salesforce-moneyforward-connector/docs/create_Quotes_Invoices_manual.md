**種別**: A. 一般的なシステム操作・管理マニュアル

**対象読者レベル**: 2. 中級者（基本的なIT操作は可能）

**※ 見積書発行は本内容の「請求書」の部分を「見積書」と変えて読んでください**

---

## 1. マニュアル概要

### 1.1 目的・対象読者

- **目的**: Salesforce商談データから請求書情報を取り込み、MoneyForwardで請求書を自動発行する
- **対象読者**: 営業事務、経理担当者、請求業務担当者
- **前提スキル**: Google Sheets操作、Salesforce基本操作、請求業務の基礎知識
- **学習時間の目安**: 初回設定20分、日常運用10分

### 1.2 マニュアルの使い方

- **構成**: 初期設定→データ取り込み→請求書発行の順で構成
- **表記ルール**:
    - `ボタン名` : クリック対象
    - **重要** : 特に注意が必要な箇所
    - 💡 : 効率化のためのTips
    - ⚠️ : 警告・注意事項
- **関連資料**: Salesforce商談管理、MoneyForward請求書機能

### 1.3 重要な注意事項

- **請求書発行**: 一度発行した請求書は取り消しができません
- **データ確認**: 発行前に金額・内容を十分確認してください
- **権限管理**: 両システムの適切な権限が必要です
- **サポート**: 問題発生時は経理担当者またはIT管理者まで連絡

---

## 2. 事前準備

### 2.1 必要な権限・アクセス

**Salesforce権限**:

- 商談（Opportunity）の参照権限
- 売上詳細（ItemAccountDetail__c）の参照権限
- 取引先（Account）の参照・編集権限

**MoneyForward権限**:

- 請求書の作成・編集権限
- 取引先の参照権限
- API接続権限

**Google Sheets権限**:

- 対象スプレッドシートの編集権限
- Google Apps Script の実行権限

### 2.2 環境・ツール準備

- **推奨ブラウザ**: Google Chrome最新版
- **ネットワーク**: 安定したインターネット接続
- **Google アカウント**: 組織のGoogle Workspaceアカウント

### 2.3 基礎知識・用語解説

- **商談URL**: Salesforceの商談ページのURL
- **売上詳細**: 商談に紐づく請求明細情報
- **取り込み**: Salesforceから請求データをスプレッドシートに読み込む処理
- **バッチ発行**: 複数の請求書を一括で発行する機能

---

## 3. 基本操作ガイド

### 3.1 システムへのアクセス

1. Google Sheets で対象のスプレッドシートを開く
2. 上部メニューバーに `Options` メニューが表示されることを確認
3. 初回利用時は「マネーフォワード認証」から開始

### 3.2 初回設定（初回のみ）

**MoneyForward認証設定**:

1. `Options` → `マネーフォワード認証` → `初期設定` をクリック
2. Client ID と Client Secret を入力（管理者から提供）
3. 「設定完了」のメッセージとリダイレクトURIを確認
4. リダイレクトURIをMoneyForwardのAPI設定に登録（管理者作業）

**認証実行**:

1. `Options` → `マネーフォワード認証` → `認証開始` をクリック
2. 表示されるモーダルダイアログの「認証を開始」をクリック
3. MoneyForwardの認証ページで認証を完了
4. 「認証成功！」のメッセージを確認

**認証確認**:

1. `Options` → `マネーフォワード認証` → `認証状況確認` をクリック
2. 「認証済みです」のメッセージを確認

💡 **Tips**: 認証は一度設定すれば継続して利用可能。定期的な再認証が必要な場合があります

---

## 4. 機能別詳細ガイド

### 4.0 システム処理フロー概要

- 4.0.1 取引先情報同期フロー (別[マニュアル](https://www.notion.so/Salesforce-MoneyForward-21cd48a3c2cb80bfb3ebcbb4148bd8de?pvs=21)参照のこと)
    
    ```mermaid
    sequenceDiagram
        participant User as ユーザー
        participant GAS as GAS
        participant Sheet as スプレッドシート
        participant SF as Salesforce
        participant MF as MoneyForward
    
        Note over User,MF: 初期設定
        User->>GAS: 設定・認証
        GAS->>Sheet: 設定保存
        GAS->>MF: OAuth認証
        GAS->>SF: API接続確認
    
        Note over User,MF: 完全同期
        User->>GAS: 完全同期実行
        
        GAS->>MF: 全取引先取得
        MF-->>GAS: 取引先一覧
        
        GAS->>Sheet: 取引先管理シート更新
        
        loop 各MF取引先
            GAS->>SF: 対応Account確認
            alt Account存在
                GAS->>SF: リンク情報更新
            else Account不存在
                GAS->>Sheet: 削除候補登録
            end
        end
        
        loop 各SFAccount
            GAS->>GAS: 住所変更チェック
            alt 変更あり
                GAS->>MF: 取引先情報更新
                GAS->>SF: 同期状態更新
            end
        end
        
        GAS->>Sheet: 同期ログ記録
        GAS-->>User: 完了通知
    
        Note over User,MF: 増分同期（定期実行）
        User->>GAS: 増分同期実行
        GAS->>SF: 最近変更Account取得
        SF-->>GAS: 変更Account一覧
        
        loop 変更されたAccount
            GAS->>MF: 取引先情報更新
            GAS->>SF: 同期日時更新
        end
        
        GAS->>Sheet: ログ記録
        GAS-->>User: 完了通知
    ```
    
- 4.0.2 請求書発行フロー
    
    ```mermaid
    sequenceDiagram
        participant User as ユーザー
        participant GAS as GAS
        participant Sheet as スプレッドシート
        participant SF as Salesforce
        participant MF as MoneyForward
        participant Output as アウトプットシート
    
        Note over User,Output: 認証設定
        User->>GAS: 認証設定
        GAS->>MF: OAuth認証
        GAS->>SF: API接続確認
    
        Note over User,Output: 請求書発行
        User->>Sheet: 請求対象情報取り込み情報入力
        User->>GAS: 請求対象情報取り込み実行
        GAS->>Output: 取り込み
        User->>GAS: 発行対象選択
        User->>GAS: 発行実行
        
        loop 各請求書
            GAS->>Sheet: 処理中ステータス更新
            
            GAS->>SF: 商談・取引先情報取得
            SF-->>GAS: 商談データ返却
            
            GAS->>Output: アウトプットデータ取得
            Output-->>GAS: 請求書データ返却
            
            GAS->>GAS: MoneyForward形式変換
            Note right of GAS: 税率変換・日付統一・検証
            
            GAS->>MF: 請求書作成
            alt 成功
                MF-->>GAS: 請求書ID・番号返却
                GAS->>SF: 商談に請求書ID設定
                GAS->>Sheet: 完了ステータス更新
            else 失敗
                MF-->>GAS: エラー返却
                GAS->>Sheet: エラーステータス・ログ更新
            end
        end
        
        GAS-->>User: 処理完了通知
    
        Note over User,Output: 運用機能
        User->>GAS: 統計・エラーログ確認
        GAS->>Sheet: データ集計・取得
        GAS-->>User: 結果表示
    ```
    

### 4.1 請求情報の取り込み

**目的・使用場面**:

- Salesforce商談から請求書データを取り込む
- 請求書発行の前段階として必須

**操作手順**:

1. Salesforceで対象商談のURLをコピー
2. スプレッドシートのB3セルに商談URLを貼り付け
3. `Options` → `請求情報をSalesforceから取り込み` をクリック
4. 処理完了まで待機（30秒-2分程度）
5. 完了ダイアログでファイルURLを確認

**取り込まれるデータ**:

- 取引先名称・件名
- 請求日・支払期限・売上計上日
- 明細データ（品名・単価・数量・金額）
- 税率・消費税額

**⚠️ 注意事項**:

- 商談URLは正確にコピーしてください
- 売上詳細データが未入力の商談はエラーになります
- 取引先がMoneyForwardと連携されている必要があります

### 4.2 請求書の発行

**目的・使用場面**:

- 取り込んだデータからMoneyForwardで請求書を発行
- 複数件の一括発行も可能

**単一発行の手順**:

1. 「請求書ログ」シートを確認
2. 発行したい行のチェックボックスにチェックを入れる
3. `Options` → `📄 Moneyforwardで請求書を発行` をクリック
4. 発行ダイアログで「発行開始」をクリック
5. 進捗を確認し、完了を待つ
6. 処理結果（成功・エラー件数）を確認

**バッチ発行の手順**:

1. 「請求書ログ」シートで複数行をチェック
2. または「全て選択」「未処理のみ選択」機能を活用
3. 発行処理は単一発行と同じ手順
4. 進捗バーで全体の進捗を確認

**発行結果の確認**:

- **発行ステータス**: 未処理 → 処理中 → 完了/エラー
- **請求書番号**: MoneyForwardで発行された請求書番号
- **発行日時**: 発行完了日時
- **エラーメッセージ**: 失敗時の詳細

💡 **Tips**: 大量発行時は処理に時間がかかります。1件あたり約3秒の処理時間を見込んでください

---

## 5. 緊急時・イレギュラー対応

**エラー案件の対応**:

1. エラーメッセージの確認
2. Salesforceデータの修正
3. 再取り込み・再発行の実行

**認証エラー時の対応**:

1. 認証状況の確認
2. 必要に応じて再認証実行
3. IT管理者への報告

---

## 6. データ管理ガイド

### 6.1 請求書ログシートの見方

**主要な列**:

- **A列（チェック）**: 発行対象の選択
- **B列（実行日時）**: データ取り込み日時
- **C列（商談URL）**: 元となるSalesforce商談
- **D列（商談ID）**: システム内部ID
- **E列（取引先名称）**: 請求先企業名
- **F列（件名）**: 商談・請求件名
- **G列（アウトプットURL）**: 生成されたCSVファイル
- **H列（実行結果）**: 取り込み結果
- **I列（発行ステータス）**: 請求書発行状況
- **J列（請求書番号）**: MoneyForward請求書番号
- **K列（発行日時）**: 発行完了日時
- **L列（エラーメッセージ）**: エラー詳細

**ステータス色分け**:

- **白色**: 未処理
- **黄色**: 処理中
- **緑色**: 完了
- **赤色**: エラー

### 6.2 データ品質の確認方法

**取り込み前の確認**:

- Salesforceで売上詳細データの完成度確認
- 取引先のMoneyForward連携状況確認
- 金額・税率の正確性確認

**発行前の確認**:

- アウトプットファイルの内容確認
- 請求金額の妥当性確認
- 取引先情報の正確性確認

---

## 7. トラブルシューティング

### 7.1 よくある問題・対処法

**「有効な商談URLを入力してください」エラー**:

- **原因**: 商談URLの形式が正しくない
- **対処法**: Salesforce商談ページから正確にURLをコピー
- **確認点**: URLに商談IDが含まれているか

**「取引先が同期されていません」エラー**:

- **原因**: SalesforceとMoneyForwardの取引先連携未完了
- **対処法**: 取引先同期システムで該当企業を連携
- **手順**: 該当取引先の `MoneyForward_Partner_ID__c` 設定確認

**「売上詳細が見つかりません」エラー**:

- **原因**: 商談に売上詳細データが未入力
- **対処法**: Salesforceで売上詳細（ItemAccountDetail__c）を入力
- **確認点**: 品名・数量・単価が適切に設定されているか

**「認証が必要です」エラー**:

- **原因**: MoneyForward認証の期限切れ
- **対処法**: 再認証を実行
- **手順**: `マネーフォワード認証` → `認証開始`

### 7.2 データ・内容関連問題

**税率が正しく設定されない**:

- **確認点**: 品名に「CB金額」が含まれる場合は非課税扱い
- **対処法**: 必要に応じてSalesforceの品名を調整

**請求金額が合わない**:

- **確認点**:
    - 売上詳細の「請求金額」フィールド
    - 税率計算（10%標準、CB金額は非課税）
    - 小計・消費税・総額の計算

**数量が0になる**:

- **原因**: 請求書では「実績数量」を使用
- **対処法**: Salesforceで実績数量を適切に入力

### 7.3 システム・処理関連問題

**処理が途中で止まる**:

- **原因**: ネットワーク接続不安定、API制限
- **対処法**:
    - 安定したネットワーク環境での再実行
    - 少量ずつの分割処理

**「スプレッドシートの取得に失敗しました」エラー**:

- **原因**: アウトプットファイルのアクセス権限問題
- **対処法**: Google Driveの共有設定を確認

---

## 8. FAQ・よくある質問

### 8.1 操作・機能に関するFAQ

**Q: 一度発行した請求書を修正できますか？**

A: MoneyForwardで発行済みの請求書は、MoneyForward側で修正する必要があります。システムからの再発行はできません。

**Q: 複数の商談を一度に処理できますか？**

A: 取り込みは1件ずつですが、発行は複数件を一括処理できます。取り込み済みのデータをチェックして一括発行してください。

**Q: エラーになった案件はどう対応すればよいですか？**

A: エラーメッセージを確認し、Salesforceのデータを修正後、再取り込み・再発行を実行してください。

### 8.2 業務・運用に関するFAQ

**Q: どのタイミングで請求書を発行すべきですか？**

A: 商談が「完了」ステージになり、実績数量が確定したタイミングが適切です。

**Q: 見積書も同じように発行できますか？**

A: 現在は請求書のみ対応。見積書は計画数量を使用する別機能として今後実装予定です。

**Q: 発行した請求書の確認方法は？**

A: MoneyForwardの請求書一覧から請求書番号で検索して確認してください。

### 8.3 技術・データに関するFAQ

**Q: 税率の判定基準は？**

A: 品名に「CB金額」が含まれる場合は非課税、それ以外は10%の標準税率となります。

**Q: 取引先の住所情報はどこから取得されますか？**

A: Salesforce Accountの請求先住所情報から自動取得されます。

**Q: 処理時間はどのくらいかかりますか？**

A: 取り込み：30秒-2分、発行：1件あたり約3秒が目安です。

---

## 9. 効率的な運用のためのTips

### 9.1 選択機能の活用

**一括選択機能**:

- 「全て選択」: 全ての行を選択
- 「全て選択解除」: 全ての選択を解除
- 「未処理のみ選択」: 未処理ステータスの行のみ選択

**効率的な発行順序**:

1. 同じ取引先の複数案件をまとめて処理
2. 金額の大きい案件から優先処理
3. エラーになりやすい案件は個別処理

### 9.2 品質管理のコツ

**発行前チェックポイント**:

- [ ]  取引先名の正確性
- [ ]  請求金額の妥当性
- [ ]  税率の適切性
- [ ]  納品日の設定

**エラー予防策**:

- Salesforceでの売上詳細入力ルールの統一
- 取引先の事前連携確認
- 定期的な認証状況確認

---

## 10. 日常運用チェックリスト

### 10.1 処理開始前

- [ ]  MoneyForward認証状況確認
- [ ]  対象商談の売上詳細完成度確認
- [ ]  取引先の連携状況確認

### 10.2 取り込み処理後

- [ ]  エラーの有無確認
- [ ]  アウトプットファイル内容確認
- [ ]  請求金額の妥当性確認

### 10.3 発行処理後

- [ ]  発行ステータス確認
- [ ]  エラー案件の対応
- [ ]  MoneyForwardでの請求書確認

### 10.4 定期確認（週次）

- [ ]  未処理案件の確認
- [ ]  エラー統計の確認
- [ ]  システム動作状況確認

---

## 11. 問い合わせ・サポート

### 11.1 段階的問い合わせ先

1. **操作方法**: このマニュアルを参照
2. **データ・内容問題**: 経理担当者
3. **システム・認証問題**: IT管理者
4. **Salesforceデータ**: 営業・営業事務
5. **MoneyForward操作**: 経理・財務担当

### 11.2 問い合わせ時に準備する情報

- エラーメッセージのスクリーンショット
- 該当商談のURL
- 実行した操作の詳細手順
- エラー発生時刻

---

**最終更新**: 2024年12月

**マニュアル版本**: 1.0
